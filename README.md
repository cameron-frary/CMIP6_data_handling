This is a package written by Cameron Frary to make it simpler and easier to use data from the Coupled Model Intercomparison Project Phase 6 (CMIP6). There is only one object with seven methods. Users can easily select their desired model-experiment-variable combination, and create plots and animation. It is also easy to retrieve data from the object for external manipulation.

Using the package only requires cloning the repository and importing `CMIP6_Data_Manager` from `CMIP6_data_handling.data_handling`.

## Why

The object deals with all the initialization of objects necessary to the CMIP6 query, and deals with facets of plotting and animations that most would usually like to ignore.

## Drawbacks

The package has only been used in Google Colab. We had some difficulty installing and importing some dependencies on other systems and the code for doing so in Colab was provided.

Please also note that procedures involving comparisons between simulation data take significantly longer than the same procedures without comparison. Bottlenecks in the `xarray` package are to blame.

## Structure

### `CMIP6_Data_Manager`

This is the main object. It contains everything you need.

It has the following attributes:
- `self.query`: the query passed when initialized.
- `self.baseline_params`: a triple of the parameters (time or time interval, experiment, and variable) used to determine baseline data for comparisons
- `self.baseline_data`: the actual data associated with the above parameters
- `self.cat`: the catalogue of results returned by the query
- `self.df`: the unpacked dataframe generated by the results catalogue. **This is what users would use to access the raw data**. It is structured `experiment_id/variable_id` as most usage will involve only one of every other parameter.
- `self.specifics`: **This is the only attribute that users might interact with**. It is a dictionary of specific abnormal dimensions that need to be specified before plotting (see `specifics` parameter in `init` function documentation).

#### Initialization

We have the following parameters:

- `query`: a dictionary containing fields to be passed to the CMIP6 search. Some common keys are `source_id` (model), `variable_id` (variable), `experiment_id` (experiment/forcing situation), and `table_id` (combination of part of model and time resolution). Values can be arrays. I highly recommend specifying at least the first three.
- `time_frame` (default `None`): a string specifying desired time resolution. Examples include `"mon"`, `"day"`, or `"yr"`. Not strictly necessary, but helpful when `table_id` is not specified in `query`.
- `specifics` (default `None`): a dictionary to specify additional dimensions, with the dimension name as the key and the desired value as the value (`{dim : val}`). Some variables will have a depth or altitude dimension (usually called `lev`). The dimension/key should be a string, and the val will usually be an integer.

It can take a long time to unpack the returned data, so I suggest limiting the number of variable/experiment combinations possible. 

In the following example usage, I query surface air pressure data (`ps`) from the GFDL-ESM4 model for the `historical` and `ssp585` experimental forcing situations. I want time resolution on the monthly scale, but I don't know the best table ID. **Has not been tested with time resolutions smaller than montly**.
```
gfdl_esm4_pressure = CMIP6_Data_Manager(
    query= dict(
        source_id="GFDL-ESM4",
        variable_id=["ps"],
        experiment_id=["ssp585", "historical"]
    ),
    time_frame="mon"
)
```
We see from the following output that a `table_id` was automatically chosen. Other possible `table_id`s are displayed in case you want to specify a `table_id` (here `CFmon` might be a good option as it seems to be coupled---it incorporates data from several parts of the model). 
```
****Using Amon as table_id (options were ['Amon' 'CFday' 'CFmon' 'AERmon' 'Emon'])****
```

#### `make_plot(self, title, cmap_label, cmap, main, baseline=None, central_lon=0, vmin=None, vmax=None, block_land=True)

Makes a plot (default 12 by 6, ccrs.PlateCarree projection).

Required:

- `title`: title of the plot
- `cmap`: colormap (should be from `cmocean.cm`)
- `cmap_label`: label of colormap
- `main`: data to be plotted (unless `baseline` specified). Should have format `(time, experiment, variable)`. The `time` part of the triple should be an array of format `[time]` or `[time1, time2]`. The format of specific times is either "YYYY" or "YYYY-MM".

Optional:

- `baseline` (default `None`): parameters for baseline data for comparison with `main`. Should have the same format as main. Note that if the experiment is `historical` or `land-hist`, the time section can be an empty array, as the program will automatically average over all available historical data. Comparison data given by (main-baseline)/baseline.
- `central_lon` (default `0`): central longitude of the plot. For example, `central_lon = -105` will center 105 degrees W for focus on the Pacific Ocean.
- `vmin`, `vmax` (default `None`): min and max values for the colormap, respectively. Default `None` allows the colormap to default to min and max values in the data
- `block_land` (default `True`): Mask land. Setting it to `False` allows dynamics over land to be viewed.

#### make_animation(self, years, months, vmin, vmax, cmap, main, cmap_label, baseline=None, central_lon=0, name="animation")

Generates a `.mp4` with filename `name` (default `animation.mp4`). 

Required:

- `years`: iterable of integers. Must be totally within range of experiment (ex. can't include 2025 when looking at historical data).
- `months`: iterable of integers. Usually array of exactly one (ex. `[7]` when looking specifically at July). Leaving empty (`[]`) averages over entire year.
- `vmin`, `vmax`: min and max values for the colormap, respectively. Needs to be specified for consistent color range across frames.
- `cmap`: colormap (should be from `cmocean.cm`)
- `cmap_label`: label of colormap
- `main`: data to be plotted (unless `baseline` specified). Should have format `(time, experiment, variable)`. The `time` part of the triple should be an array of format `[time]` or `[time1, time2]`. The format of specific times is either "YYYY" or "YYYY-MM".

Optional:

- `baseline` (default `None`): parameters for baseline data for comparison with `main`. Should have the same format as main. Note that if the experiment is `historical` or `land-hist`, the time section can be an empty array, as the program will automatically average over all available historical data. Comparison data given by (main-baseline)/baseline. The only exception is if it has the format `("rolling", experiment, variable)`, where the `"rolling"` indicates that the comparison should be between experiments (or variables, I guess) for the same year. In my usage I exclusively used averaged historical data as the baseline.
- `central_lon` (default `0`): central longitude of the plot. For example, `central_lon = -105` will center 105 degrees W for focus on the Pacific Ocean.
- `name` (default `"animation"`): filename of the outputted `.mp4`.

#### `get_data(self, main, baseline_params=None, data_slice=False)`

Almost entirely internal usage. Gets data using the `main` and (if given) `baseline_params` triples as described above. If `data_slice = True` is specified, it returns data from between the given times (if the times given in `main` is an interval). Baseline data is only ever for a specific time value.

#### `sel_time(self, data, experiment, time, data_slice = False)`

This function is mostly internal. It selects a frame or slice of frames from the data for the given experiment and time (or time interval when `data_slice = True` is specified).

#### `attempt_dim_fix(self, data, desired_dims)`

Again mostly internal, this function is run before returning data for plotting. It makes sure that the data has the desired number of dimensions. When the data does not, it uses the `input()` method to take a key and value and attempts to specify outstanding dimensions. The key-value pair are added to `self.specifics`. _It is best to just specify the necessary dimensions when initializing the object._

#### `sel_specifics(self, data, experiment)`

Yet again, mostly internal. It selects data using the `self.specifics` dictionary to eliminate extra dimensions. Some variables (such as primary productivity) involve integrating over an interval of an extra dimension, so certain values of `experiment` result in special behavior.

#### `update_baseline(self, baseline_params)`

Mostly internal. Updates `self.baseline_params` and `self.baseline_data` according to the passed parameters. Used only in comparisons (hence the need for a baseline).
